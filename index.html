<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sub-Box</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <style type="text/css">
        body {
            padding-top: 50px;
            background: #f1f1f1;
        }

        #login-container {
            padding: 40px 16px;
            text-align: center;
        }

        #video-container {
            margin: 10px 0;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .1);
        }

        .video {
            border-bottom: 1px solid #e2e2e2;
            padding: 15px;
        }

        .video img {
            padding-bottom: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div id="login-container" class="pre-auth col-xs-12 col-sm-6 col-sm-offset-3">
                <h1>Access to YouTube Required</h1>
                <p class="lead">This application requires acces to your YouTube account in order to see what channel's your subscribed to.</p>
                <button class="btn btn-primary" id="login-link">Authorize</button>
            </div>
        </div>
        <div id="video-container" class="row"><div class="col-xs-12"></div></div>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript">
        var OAUTH2_CLIENT_ID = '126126374554-rds5pbeaqeriq64jqfsnmgev16rnhn72.apps.googleusercontent.com';
        var OAUTH2_SCOPES = [
          'https://www.googleapis.com/auth/youtube'
        ];

        googleApiClientReady = function() {
          gapi.auth.init(function() {
              window.setTimeout(checkAuth, 1);
          });
        }

        function checkAuth() {
          gapi.auth.authorize({
            client_id: OAUTH2_CLIENT_ID,
            scope: OAUTH2_SCOPES,
            immediate: true
          }, handleAuthResult);
        }

        function handleAuthResult(authResult) {
          if (authResult && !authResult.error) {
            $('.pre-auth').hide();
            loadAPIClientInterfaces();
          } else {
            $('#login-link').click(function() {
              gapi.auth.authorize({
                client_id: OAUTH2_CLIENT_ID,
                scope: OAUTH2_SCOPES,
                immediate: false
                }, handleAuthResult);
            });
          }
        }

        function loadAPIClientInterfaces() {
          gapi.client.load('youtube', 'v3', function() {
              requestUserSubscriptions();
          });
        }

        var subscriptions = [];
        function requestUserSubscriptions(pageToken) {
            if (!pageToken) subscriptions = [];
            var requestOptions = {
                mine: true,
                part: 'snippet',
                maxResults: 50
            }
            if (pageToken) requestOptions.pageToken = pageToken;
            gapi.client.youtube.subscriptions.list(requestOptions).then(function (response) {
                $.each(response.result.items, function(i, subscription) {
                    subscriptions.push(subscription.snippet.resourceId.channelId);
                });
                var next = response.result.nextPageToken;
                next ? requestUserSubscriptions(next) : requestChannelInfo()
            });
        }

        function requestChannelInfo() {
            playlistIds = [];
            var batch = gapi.client.newBatch();
            while (subscriptions.length) {
                batch.add(gapi.client.youtube.channels.list({
                    part: 'contentDetails',
                    id: subscriptions.splice(0, 50).join(','),
                    maxResults: 50
                }));
            }
            batch.then(function(responses) {
                $.each(responses.result, function(i, response) {
                    $.each(response.result.items, function(i, channel) {
                        playlistIds.push(channel.contentDetails.relatedPlaylists.uploads);
                    });
                });
                requestPlaylists(playlistIds);
            });
        }

        function requestPlaylists(playlistIds) {
            videoIds = [];
            var batch = gapi.client.newBatch();
            while(playlistIds.length) {
                batch.add(gapi.client.youtube.playlistItems.list({
                    playlistId: playlistIds.splice(0,1),
                    part: 'snippet',
                    maxResults: 5
                }));
            }
            batch.then(function(responses) {
                $.each(responses.result, function(i, response) {
                    $.each(response.result.items, function(i, playlistItem) {
                        videoIds.push(playlistItem.snippet.resourceId.videoId);
                    });
                });
                requestVideos(videoIds);
            });
        }

        function requestVideos(videoIds) {
            videos = [];
            var batch = gapi.client.newBatch();
            while(videoIds.length) {
                batch.add(gapi.client.youtube.videos.list({
                    id: videoIds.splice(0,50).join(','),
                    part: 'snippet',
                    maxResults: 50
                }));
            }
            batch.then(function(responses) {
                $.each(responses.result, function(i, response) {
                    $.each(response.result.items, function(i, video) {
                        videos.push(video);
                    });
                });
                displayVideos(videos);
            });
        }

        function displayVideos(videos) {
            videos.sort(function(a, b) {
                a = new Date(a.snippet.publishedAt); b = new Date(b.snippet.publishedAt);
                return a > b ? -1 : (a < b ? 1 : 0);
            });
            var fragment = document.createDocumentFragment();
            $.each(videos.slice(0,100), function(i, video) {
                var d = document.createElement('div');
                d.className = "row video";
                d.innerHTML = "<div class='col-xs-12'>" +
                                   "<div class='row'>" +
                                       "<div class='col-xs-12'><h4>" + video.snippet.channelTitle + "</h4></div>" +
                                   "</div>" +
                                   "<div class='row'>" +
                                       "<div class='col-xs-12 col-sm-5 col-md-4'>" +
                                           "<a href='https://youtube.com/watch?v=" + video.id + "'><img src='" + video.snippet.thumbnails.medium.url + "'></a>" +
                                       "</div>" +
                                       "<div class='col-xs-12 col-sm-7 col-md-8'>" +
                                           "<a href='https://youtube.com/watch?v=" + video.id + "'><strong>" + video.snippet.title + "</strong></a>" +
                                           "<p>" + new Date(video.snippet.publishedAt).toLocaleString() + "</p>" +
                                           "<p>" + video.snippet.description + "</p>" +
                                       "</div>" +
                                   "</div>" +
                              "</div>";
                fragment.appendChild(d);
            });
            $("#video-container").find("div")[0].appendChild(fragment);
        }
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://apis.google.com/js/client.js?onload=googleApiClientReady"></script>
</body>
</html>